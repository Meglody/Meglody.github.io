<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#6200ee"><meta name="author" content="卡西猫倒"><meta name="copyright" content="卡西猫倒"><meta name="generator" content="Hexo 5.4.0"><meta name="theme" content="hexo-theme-yun"><title>读《Vue.js设计与实现》- 框架设计概览 | 卡西猫倒的小站</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.25/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism.css" media="(prefers-color-scheme: light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism-tomorrow.css" media="(prefers-color-scheme: dark)"><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#6200ee"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"meglody.github.io","root":"/","title":"卡西猫倒的小站","version":"1.7.0","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg"};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><link rel="stylesheet" href="/css/markdown-mine.css"><link rel="stylesheet" href="/css/markdown-meglody.css"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin><script async src="https://www.googletagmanager.com/gtag/js?id=G-DBJ06R3DVX"></script><script>if (CONFIG.hostname === location.hostname) {
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-DBJ06R3DVX');
}</script><script>(function(){
  var bp = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else {
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();</script><meta name="description" content="了解大型框架要从读源码开始。 了解源码设计与实现思想要从框架的设计和参与者的书本开始。">
<meta property="og:type" content="article">
<meta property="og:title" content="读《Vue.js设计与实现》- 框架设计概览">
<meta property="og:url" content="https://meglody.github.io/read/%E8%AF%BB%E3%80%8AVue-js%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E3%80%8B-%20%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1%E6%A6%82%E8%A7%88/index.html">
<meta property="og:site_name" content="卡西猫倒的小站">
<meta property="og:description" content="了解大型框架要从读源码开始。 了解源码设计与实现思想要从框架的设计和参与者的书本开始。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-02-20T02:04:23.000Z">
<meta property="article:modified_time" content="2022-02-22T03:06:13.000Z">
<meta property="article:author" content="卡西猫倒">
<meta property="article:tag" content="架构">
<meta property="article:tag" content="vue">
<meta property="article:tag" content="编译">
<meta property="article:tag" content="js">
<meta property="article:tag" content="虚拟DOM">
<meta name="twitter:card" content="summary"><script src="/js/ui/mode.js"></script></head><body><canvas id="trianglifyContainer"></canvas><script defer src="https://cdn.jsdelivr.net/npm/trianglify@4/dist/trianglify.bundle.js"></script><script>document.addEventListener("DOMContentLoaded", () => {
  const pattern = trianglify({
    width: 800,
    height: 600,
    cellSize: 75,
    palette: ["YlGnBu", "GnBu", "Purples", "Blues"],
  });
  const canvasOpts = {
    applyCssScaling: false
  }
  document.body.appendChild(pattern.toCanvas(trianglifyContainer, canvasOpts));
});</script><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="卡西猫倒"><img width="96" loading="lazy" src="https://shanghai-1309153523.cos.ap-shanghai.myqcloud.com/blogImage/avatar2.jpeg" alt="卡西猫倒"><span class="site-author-status" title="学习中">🐱‍🐉</span></a><div class="site-author-name"><a href="/about/">卡西猫倒</a></div><span class="site-name">卡西猫倒的小站</span><sub class="site-subtitle">过往一瞬，知己者寥数，善己者方能几何？勿忘初心，珍惜现在，随遇而安，岁月静好。</sub><div class="site-desciption">好学前端，喜欢研究工程化/部署运维，TS，WebGL，目前学习WebGL、React、元数据和架构</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">11</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">4</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">30</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="Yun主题文档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://wpa.qq.com/msgrd?v=3&amp;uin=30755703&amp;site=qq&amp;menu=yes" title="QQ" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/Meglody" title="GitHub" target="_blank" style="color:#181717"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:30755703@qq.com" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=260476301" title="网易云音乐" target="_blank" style="color:#C10D0C"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/453065" title="哔哩哔哩动画" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%AF%87-%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1%E6%A6%82%E8%A7%88"><span class="toc-number">1.</span> <span class="toc-text">第一篇 框架设计概览</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%AB%A0-%E6%9D%83%E8%A1%A1%E7%9A%84%E8%89%BA%E6%9C%AF"><span class="toc-number">1.1.</span> <span class="toc-text">第一章 权衡的艺术</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E5%BC%8F%E4%B8%8E%E5%A3%B0%E6%98%8E%E5%BC%8F"><span class="toc-number">1.1.1.</span> <span class="toc-text">命令式与声明式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E5%92%8C%E7%BC%96%E8%AF%91%E6%97%B6%E7%9A%84%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9A"><span class="toc-number">1.1.2.</span> <span class="toc-text">运行时和编译时的相关知识：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%AF%E8%BF%90%E8%A1%8C%E6%97%B6"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">纯运行时:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E6%97%B6-%E8%BF%90%E8%A1%8C%E6%97%B6%EF%BC%9A"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">编译时 + 运行时：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%AF%E7%BC%96%E8%AF%91%E6%97%B6%EF%BC%9A"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">纯编译时：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1%E7%9A%84%E6%A0%B8%E5%BF%83%E8%A6%81%E7%B4%A0"><span class="toc-number">1.2.</span> <span class="toc-text">第二章 框架设计的核心要素</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E5%8D%87%E5%BC%80%E5%8F%91%E4%BD%93%E9%AA%8C"><span class="toc-number">1.2.1.</span> <span class="toc-text">提升开发体验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E6%A1%86%E6%9E%B6%E7%9A%84%E4%BD%93%E7%A7%AF"><span class="toc-number">1.2.2.</span> <span class="toc-text">控制框架的体积</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%86%E6%9E%B6%E8%A6%81%E5%81%9A%E5%88%B0%E8%89%AF%E5%A5%BD%E7%9A%84-Tree-Shaking"><span class="toc-number">1.2.3.</span> <span class="toc-text">框架要做到良好的 Tree-Shaking</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%86%E6%9E%B6%E5%BA%94%E8%AF%A5%E8%BE%93%E5%87%BA%E6%80%8E%E6%A0%B7%E7%9A%84%E6%9E%84%E5%BB%BA%E4%BA%A7%E7%89%A9"><span class="toc-number">1.2.4.</span> <span class="toc-text">框架应该输出怎样的构建产物</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E6%80%A7%E5%BC%80%E5%85%B3"><span class="toc-number">1.2.5.</span> <span class="toc-text">特性开关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%89%AF%E5%A5%BD%E7%9A%84typescript%E6%94%AF%E6%8C%81"><span class="toc-number">1.2.6.</span> <span class="toc-text">良好的typescript支持</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E7%AB%A0-Vue-js-3-%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF"><span class="toc-number">1.3.</span> <span class="toc-text">第三章 Vue.js 3 的设计思路</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E5%BC%8F%E7%9A%84%E6%8F%8F%E8%BF%B0UI"><span class="toc-number">1.3.1.</span> <span class="toc-text">声明式的描述UI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E8%AF%86%E6%B8%B2%E6%9F%93%E5%99%A8"><span class="toc-number">1.3.2.</span> <span class="toc-text">初识渲染器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E7%9A%84%E6%9C%AC%E8%B4%A8"><span class="toc-number">1.3.3.</span> <span class="toc-text">组件的本质</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E7%89%88%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.4.</span> <span class="toc-text">模版工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Vue-js-%E6%98%AF%E5%90%84%E4%B8%AA%E6%A8%A1%E5%9D%97%E7%BB%84%E6%88%90%E7%9A%84%E6%9C%89%E6%9C%BA%E6%95%B4%E4%BD%93"><span class="toc-number">1.3.5.</span> <span class="toc-text">Vue.js 是各个模块组成的有机整体</span></a></li></ol></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://meglody.github.io/read/%E8%AF%BB%E3%80%8AVue-js%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E3%80%8B-%20%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1%E6%A6%82%E8%A7%88/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="卡西猫倒"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="卡西猫倒的小站"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">读《Vue.js设计与实现》- 框架设计概览<a class="post-edit-link" href="https://github.com/Meglody/Meglody.github.io/tree/main/source/_posts/read/读《Vue-js设计与实现》- 框架设计概览.md" target="_blank" title="编辑" rel="noopener"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-edit-line"></use></svg></a></h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <span class="post-meta-icon-text">发表于</span> <time title="创建时间：2022-02-20 10:04:23" itemprop="dateCreated datePublished" datetime="2022-02-20T10:04:23+08:00">2022-02-20</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <span class="post-meta-icon-text">更新于</span> <time title="修改时间：2022-02-22 11:06:13" itemprop="dateModified" datetime="2022-02-22T11:06:13+08:00">2022-02-22</time></div><span class="leancloud_visitors" id="/read/%E8%AF%BB%E3%80%8AVue-js%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E3%80%8B-%20%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1%E6%A6%82%E8%A7%88/" data-flag-title="读《Vue.js设计与实现》- 框架设计概览"><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="阅读次数"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-eye-line"></use></svg> <span class="leancloud-visitors-count"></span></span></span><span class="post-meta-divider">-</span><a href="#comment"><span class="post-meta-item-icon" title="评论数"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-chat-3-line"></use></svg> <span class="waline-comment-count" id="/read/%E8%AF%BB%E3%80%8AVue-js%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E3%80%8B-%20%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1%E6%A6%82%E8%A7%88/"></span></span></a><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E7%AC%94%E8%AE%B0/" style="--text-color:dimgray" itemprop="url" rel="index"><span itemprop="text">笔记</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/%E6%9E%B6%E6%9E%84/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">架构</span></a><a class="tag-item" href="/tags/vue/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">vue</span></a><a class="tag-item" href="/tags/%E7%BC%96%E8%AF%91/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">编译</span></a><a class="tag-item" href="/tags/js/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">js</span></a><a class="tag-item" href="/tags/%E8%99%9A%E6%8B%9FDOM/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">虚拟DOM</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#6200ee;"><blockquote>
<p>了解大型框架要从读源码开始。</p>
<p>了解源码设计与实现思想要从框架的设计和参与者的书本开始。</p>
</blockquote>
<span id="more"></span>

<h1 id="第一篇-框架设计概览"><a href="#第一篇-框架设计概览" class="headerlink" title="第一篇 框架设计概览"></a>第一篇 框架设计概览</h1><h2 id="第一章-权衡的艺术"><a href="#第一章-权衡的艺术" class="headerlink" title="第一章 权衡的艺术"></a>第一章 权衡的艺术</h2><h3 id="命令式与声明式"><a href="#命令式与声明式" class="headerlink" title="命令式与声明式"></a>命令式与声明式</h3><p>本章讨论了命令式和声明式两种<code>范式</code>的差异，从结果上讲：</p>
<ul>
<li>命令式更加注重过程，性能高</li>
<li>声明式更加关注结果，性能差</li>
</ul>
<p>命令式在<code>理论上</code>可以做到极致的优化，但是用户(*在这里框架的用户是开发者，后同)需要承受巨大的心智负担和高额维护成本；<br>而声明式能够有效的减少心智负担，并减少维护成本，在这个用人既是用钱的社会，人是第一成本，既是声明式则运行时性能会有一定的牺牲；<br>框架(Vue.js)设计者就从这一切入点，想出办法将性能损耗进行最小化（注意：在声明式封装命令式的基础上，性能的损耗是必然的，所以Vuejs极力于将性能损耗降到最低）；<br>所以我们现在看到的Vue是一个面向用户声明式，底层用命令式实现的框架。</p>
<p>在这里霍春阳例举了一个声明式更新的性能消耗公式:</p>
<blockquote>
<p>声明式更新的性能消耗 = 找出差异的性能消耗(B) + 直接修改的性能消耗(A)</p>
</blockquote>
<p>Vuejs中虚拟DOM的存在意义就是为了极致的缩减B的性能消耗。</p>
<p>霍春阳将原生JS操作DOM的方法(createElement)、虚拟DOM、innerHTML三者进行了比较，结果如下:</p>
<p>创建页面时:</p>
<table>
<thead>
<tr>
<th></th>
<th>innerHTML(模版)</th>
<th>虚拟DOM</th>
<th>原生JS</th>
</tr>
</thead>
<tbody><tr>
<td>纯JS运算</td>
<td>渲染HTML字符串</td>
<td>创建新的JS对象</td>
<td>无</td>
</tr>
<tr>
<td>DOM运算</td>
<td>新建所有新DOM</td>
<td>新建所有新DOM</td>
<td>新建所有新DOM</td>
</tr>
</tbody></table>
<p>更新页面时:</p>
<table>
<thead>
<tr>
<th></th>
<th>innerHTML(模版)</th>
<th>虚拟DOM</th>
<th>原生JS</th>
</tr>
</thead>
<tbody><tr>
<td>纯JS运算</td>
<td>渲染HTML字符串</td>
<td>创建新的JS对象 + Diff</td>
<td>无</td>
</tr>
<tr>
<td>DOM运算</td>
<td>销毁所有旧DOM<br/>新建所有新DOM</td>
<td>必要的DOM更新</td>
<td>必要的DOM更新</td>
</tr>
<tr>
<td>性能因素</td>
<td>与模版大小相关</td>
<td>与数据变化量相关</td>
<td>与数据变化量相关</td>
</tr>
</tbody></table>
<p>加上两个维度：心智负担、可维护性</p>
<table>
<thead>
<tr>
<th>innerHTML(模版)</th>
<th>虚拟DOM</th>
<th>原生JS</th>
</tr>
</thead>
<tbody><tr>
<td>心智负担中等</td>
<td>心智负担小</td>
<td>心智负担大</td>
</tr>
<tr>
<td>可维护性一般</td>
<td>可维护性好</td>
<td>可维护性差</td>
</tr>
<tr>
<td>性能差</td>
<td>性能不错</td>
<td>性能高</td>
</tr>
</tbody></table>
<p>可见比较不是简单的下定论，而是与创建页面/更新页面，创建页面大小/变更部分大小，有关系；</p>
<p>最后结合心智负担和可维护性，发现虚拟DOM是个还不错的选择。</p>
<h3 id="运行时和编译时的相关知识："><a href="#运行时和编译时的相关知识：" class="headerlink" title="运行时和编译时的相关知识："></a>运行时和编译时的相关知识：</h3><h4 id="纯运行时"><a href="#纯运行时" class="headerlink" title="纯运行时:"></a>纯运行时:</h4><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    tag<span class="token operator">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span> tag<span class="token operator">:</span> <span class="token string">'span'</span><span class="token punctuation">,</span> children<span class="token operator">:</span> <span class="token string">'hello world'</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">function</span> <span class="token function">Render</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> root</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>tag<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> children <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> text <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>children<span class="token punctuation">)</span>
        el<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
        obj<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=></span> <span class="token function">Render</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> el<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    root<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
</code></pre>

<p>对于用户来讲，纯运行时需要手写树形结构数据，并且不直观，心智负担和维护成本不低，Vue中这个树形结构就是虚拟DOM。</p>
<p>为了满足用户的需求，Vue引入了编译的手段，这也是在设计Vue.js时，Vue团队在编译时主要耗费精力的地方。</p>
<h4 id="编译时-运行时："><a href="#编译时-运行时：" class="headerlink" title="编译时 + 运行时："></a>编译时 + 运行时：</h4><pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>hello world<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre>
<p>经过编译 Compile ⬇</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    tag<span class="token operator">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span> tag<span class="token operator">:</span> <span class="token string">'span'</span><span class="token punctuation">,</span> children<span class="token operator">:</span> <span class="token string">'hello world'</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>这个编译时的程序就是Compiler，最后程序在用户那里就是这样呈现的：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
&lt;div>
    &lt;span>hello world&lt;/span>
&lt;/div>
</span><span class="token template-punctuation string">`</span></span>
<span class="token comment">// 调用Compiler编译得到树形结构的数据对象</span>
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">Compile</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
<span class="token comment">// 调用render进行渲染</span>
<span class="token function">Render</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span></code></pre>

<h4 id="纯编译时："><a href="#纯编译时：" class="headerlink" title="纯编译时："></a>纯编译时：</h4><pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>hello world<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre>

<p>经过编译 Compile ⬇</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> span <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">)</span>
span<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">'hello world'</span>
div<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>span<span class="token punctuation">)</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>div<span class="token punctuation">)</span></code></pre>

<p>纯编译时框架不需要Render函数，在Compile阶段直接生产命令式代码以达到理论最大性能（Svelte），自然它也不需要虚拟DOM，但是这种做法有损灵活性，用户提供的内容必须经过编译才能使用。</p>
<p>Vue.js 3 在编译优化方面做到了性能甚至不输纯编译时的框架，并且保留了运行时的灵活性，优化方面的内容会在后面的章节提及。</p>
<h2 id="第二章-框架设计的核心要素"><a href="#第二章-框架设计的核心要素" class="headerlink" title="第二章 框架设计的核心要素"></a>第二章 框架设计的核心要素</h2><h3 id="提升开发体验"><a href="#提升开发体验" class="headerlink" title="提升开发体验"></a>提升开发体验</h3><p>Vue3.0 使用了一套健壮的错误预警机制，当用户没有如预期的使用框架时，能使用户能够得到正确的、Vue层面的错误提示；而不是来自于JavaScript底层的错误提示。</p>
<blockquote>
<p>Vue.js中采用集中的错误处理机制来控制错误的输出</p>
</blockquote>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">//utils.js</span>
<span class="token keyword">let</span> <span class="token function-variable function">handleError</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>
    <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">callWithErrorHandling</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">registerErrorHandler</span><span class="token punctuation">(</span><span class="token parameter">handleFn</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        handleError <span class="token operator">=</span> handleFn
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">function</span> <span class="token function">callWithErrorHandling</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
        fn <span class="token operator">&amp;&amp;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// user.js</span>
<span class="token keyword">import</span> utils <span class="token keyword">from</span> <span class="token string">'./utils.js'</span>
utils<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></code></pre>

<p>这样用户得到相应的错误捕获就不必自己写tryCatch实现了</p>
<p>另外Vue为了统一注册错误收集的用户需要提供了全局的错误处理函数: </p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App.vue'</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>errorHandler <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 错误处理程序</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>在输出日志的方向，Vue也做了相应的开发优化，对于Vue内部声明的数据接口，如ref，如果想要在控制台直接的打印结果，在Chrome浏览器中通过设置DevTools中Preference中的Console -&gt; “Enable custom formatters”开启自定义格式的日志输出。实现方式可以通过在源码中查找initCustomFormatter方法。</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> number <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token comment">// RefImpl &#123;__v_isShallow: false, dep: undefined, __v_isRef: true, _rawValue: 0, _value: 0&#125; </span></code></pre>
<p>打开后</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> number <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token comment">// Ref&lt;0></span></code></pre>

<h3 id="控制框架的体积"><a href="#控制框架的体积" class="headerlink" title="控制框架的体积"></a>控制框架的体积</h3><p>通过预定义的手段，在rollup.js中定义事先准备好的环境变量 / 或通过webpack中的DefinePlugin插件，在打包之前插入到源码中去，这样在真正编译的时候，对于失效的条件分支就会进行剪枝(也叫摇树优化: tree-shaking)</p>
<blockquote>
<p>例如上面所讲的在开发环境中，Vue致力于给用户良好的代码提示和警告，而在生产环境这些代码不会被用到，需要被剪枝。</p>
</blockquote>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 所以在源码中看到的warn相关的代码长这样</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Failed to mount app: mount target selector "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>container<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">" returned null</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span></code></pre>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 在打包工具眼中长这样</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Failed to mount app: mount target selector "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>container<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">" returned null</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>最后在生产环境的代码中，直接就消失了</p>
<h3 id="框架要做到良好的-Tree-Shaking"><a href="#框架要做到良好的-Tree-Shaking" class="headerlink" title="框架要做到良好的 Tree-Shaking"></a>框架要做到良好的 Tree-Shaking</h3><p>现在无论rollup还是webpack都支持tree-shaking，但是我们通过预定义的手段来触发tree-shaking是完全不够的，例如我们项目中完全就没有用到Transition这个内部组件，那么在生产环境，它就应该被作为dead code被处理掉，这里就需要说到tree-shaking的两个条件之一：</p>
<blockquote>
<p>模块必须是ESM的:</p>
<p>因为tree-shaking只能对静态语言结构做剪枝操作，依赖于ESM的静态结构，js本身是一个动态语言，无法tree-shaking。</p>
</blockquote>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// index.js</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span>foo<span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'utils.js'</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// utils.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    obj <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span>foo
<span class="token punctuation">&#125;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    obj <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span>bar
<span class="token punctuation">&#125;</span></code></pre>
<p>打包</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>npx<span class="token punctuation">)</span> rollup index.js -f esm -o bundle.js</code></pre>
<p>得到的结果</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">//bundle.js</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    obj <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span>foo
<span class="token punctuation">&#125;</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<p>可以看到打包结果并不包含bar函数，</p>
<p>但是实际上foo也没有执行，为何没有被剪枝呢?</p>
<p>答案就是tree-shaking的<code>第二个条件</code>:</p>
<blockquote>
<p>函数必须是纯函数：</p>
<p>因为打包工具不能判断它是纯函数还是有副作用的函数</p>
</blockquote>
<p>试想一下obj的已经被defineProperty拦截了get方法，或者本身就是一个Proxy，这个Proxy代理并监听了get夹子(trap)，那打包工具无从得知在get方法中，是否存在影响全局的副作用</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// proxy</span>
<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">const</span> <span class="token function-variable function">useProxy</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> handler</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
<span class="token keyword">let</span> handler <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        count<span class="token operator">++</span>
        Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">useProxy</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    obj <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span>foo <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token comment">// 1</span></code></pre>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 亦或者</span>
<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">const</span> <span class="token function-variable function">useDefineProperty</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> handler</span><span class="token punctuation">)</span> <span class="token operator">=></span> Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'foo'</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
<span class="token keyword">let</span> handler <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        count<span class="token operator">++</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">useDefineProperty</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    obj <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span>foo <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token comment">// 1</span></code></pre>

<blockquote>
<p>正因为静态的分析javascript很难，所以打包工具都会提供一个机制告诉它“这段代码没有副作用，你可以移除”</p>
</blockquote>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> foo <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'utils.js'</span>
<span class="token comment">/*#__PURE__*/</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<p>这个注释代码<code>/*#__PURE__*/</code>就是一种标记，告诉编译器，这里的代码如果没有被调用，可以不保留，没有副作用。</p>
<h3 id="框架应该输出怎样的构建产物"><a href="#框架应该输出怎样的构建产物" class="headerlink" title="框架应该输出怎样的构建产物"></a>框架应该输出怎样的构建产物</h3><p>为了让用户能够直接通过<code>&lt;script&gt;</code>标签引入并使用，Vue需要输出IIFE格式的资源，即:</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> Vue <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    exports<span class="token punctuation">.</span>createApp <span class="token operator">=</span> createApp
    <span class="token comment">// ...</span>
    <span class="token keyword">return</span> exports
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<p>为了让用户能使用<code>&lt;script type=&quot;module&quot;&gt;</code>引入并使用，Vue需要输出ESM格式的资源。</p>
<p>需要注意的是，Vue当中ESM的资源有两种，一种是运行在浏览器端的vue.esm-broswer.js，还有一种是给打包工具使用的vue.esm-bundler.js，两者的区别在与对预定义变量<code>__DEV__</code>的处理，前者直接将<code>__DEV__</code>常量置为<code>true</code>来处理，后者将常量替换为<code>process.env.NODE_ENV === &#39;production&#39;</code>表达式。</p>
<p>这样的好处是，用户可以通过webpack或者rollup自定义构建资源的目标环境，但是被<code>__DEV__</code>标记的这段代码最后只会出现在开发环境中。</p>
<p>为了兼容服务端渲染，Vue还可以输出CJS版本的代码，这套代码是在NodeJS环境中运行的。</p>
<h3 id="特性开关"><a href="#特性开关" class="headerlink" title="特性开关"></a>特性开关</h3><p>类似于<code>__DEV__</code>，在Vue.js中还有别的一些预定义的参数，这些在优化最终代码体积时有帮助。</p>
<p>在源码中有出现<code>__FEATURE_OPTIONS_API__</code>这个常量，在构建资源时会判断输出产物是给浏览器使用的还是给打包工具使用的，如果是给<code>-bundler</code>字样的资源，即给打包工具使用的，这个参数会变为<code>__VUE_OPTIONS_API__</code>，这个参数便成为了特性开关。</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 判断</span>
<span class="token punctuation">&#123;</span>
    __FEATURE_OPTIONS_API__<span class="token operator">:</span> isBundlerESMBuild<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">__VUE_OPTIONS_API__</span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">&#125;</span></code></pre>

<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 在webpack中预定义特性开关</span>
<span class="token keyword">new</span> <span class="token class-name">Webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
     <span class="token comment">// 开启optionsApi特性</span>
     <span class="token comment">// 即打包结果中有框架提供的兼容Vue2.x的optionsApi的代码</span>
    __VUE_OPTIONS_API__<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></code></pre>

<h3 id="良好的typescript支持"><a href="#良好的typescript支持" class="headerlink" title="良好的typescript支持"></a>良好的typescript支持</h3><blockquote>
<p>其实就一句话，使用TS编写代码与对TS类型支持友好是两码事，看例子：</p>
</blockquote>
<pre class="language-typescript" data-language="typescript"><code class="language-typescript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span>val<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> val
<span class="token punctuation">&#125;</span>
<span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// const res: any</span></code></pre>

<pre class="language-typescript" data-language="typescript"><code class="language-typescript"><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">foo</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>val<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> val
<span class="token punctuation">&#125;</span>
<span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// const res: 0</span></code></pre>

<p>Vue为做到完善的TS类型支持，做了很大的努力，具体可以搜索<code>&#39;runtime-core/src/apiDefineComponent.ts&#39;</code>文件</p>
<h2 id="第三章-Vue-js-3-的设计思路"><a href="#第三章-Vue-js-3-的设计思路" class="headerlink" title="第三章 Vue.js 3 的设计思路"></a>第三章 Vue.js 3 的设计思路</h2><h3 id="声明式的描述UI"><a href="#声明式的描述UI" class="headerlink" title="声明式的描述UI"></a>声明式的描述UI</h3><p>Vue.js 3 是一个声明式的UI框架，如果让我们自己设计一个声明式的UI框架，我们自己得先知道前端页面都设计哪些内容:</p>
<ul>
<li>DOM元素：例如div标签、a标签</li>
<li>属性: a标签上的href属性，id、class属性</li>
<li>事件: click、keydown</li>
<li>元素的层级结构: DOM树的承接结构，子节点、父节点</li>
</ul>
<blockquote>
<p>拿Vue.js 3 的模版语法来说</p>
</blockquote>
<pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>handler<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>foo<span class="token punctuation">"</span></span> <span class="token attr-name">:id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    hello wolrd
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre>

<ul>
<li>使用和WHATWG规范的HTML标签一致的方式来描述DOM元素以及层级嵌套关系: <code>&lt;div&gt; hello world &lt;/div&gt;</code></li>
<li>使用与HTML标签一致的方式描述属性: <code>&lt;div class=&quot;foo&quot;&gt;&lt;/div&gt;</code></li>
<li>使用<code>:</code>或<code>v-bind</code>来描述动态绑定的属性: <code>&lt;div :id=&quot;app&quot;&gt;&lt;/div&gt;</code></li>
<li>使用<code>@</code>或<code>v-on</code>来描述事件: <code>&lt;div @click=&quot;handler&quot;&gt;&lt;/div&gt;</code></li>
</ul>
<p>可以看到用户不在需要自己手动输入命令式代码绑定事件和属性，只用之前学习HTML的成本就能很轻松的融会贯通，这也是Vue自称渐进式框架的一个原因，学习成本是渐进式的。</p>
<p>除了使用<code>模版</code>语言之外，Vue.js 3 还支持使用javascript对象(即<code>虚拟DOM</code>)来描述UI:</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> title <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    tag<span class="token operator">:</span> <span class="token string">'h1'</span><span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        onClick<span class="token operator">:</span> handler
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
            tag<span class="token operator">:</span> <span class="token string">'span'</span><span class="token punctuation">,</span>
            children<span class="token operator">:</span> <span class="token string">'hello world'</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>这也是Vue.js 3 声明式UI<code>灵活性</code>的一点体现，使用JS对象(<code>虚拟DOM</code>)来描述你甚至可以这么写:</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> level <span class="token operator">=</span> <span class="token number">5</span>
<span class="token keyword">const</span> title <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    tag<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">h</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>level<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    children<span class="token operator">:</span> level
<span class="token punctuation">&#125;</span></code></pre>
<p>用模版语句就像这样:  </p>
<pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>level === 1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">v-else-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>level === 2<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">v-else-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>level === 3<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">v-else-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>level === 4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">v-else-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>level === 5<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!-- ... --></span></code></pre>

<p>直接写<code>虚拟DOM</code>这种方式少了一个编译模版的过程，<code>*但是模版享受的优化体验(shapeFlag/patchFlag)，需要自己去实现(*自己的理解, 不一定正确, 后同)</code></p>
<p>不过真正在Vue.js 3 中写虚拟DOM，是通过工具函数<code>h()</code>来写的，<code>h</code>所做的事情，其实就是简化对象的书写方式，其生产的结果就是我们上面写的JS对象:</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> onClick<span class="token operator">:</span> handler <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>同：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
            tag<span class="token operator">:</span> <span class="token string">'h1'</span><span class="token punctuation">,</span>
            props<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                onClick<span class="token operator">:</span> handler
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            children<span class="token operator">:</span> <span class="token number">1</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>所以虚拟DOM和渲染函数其实也都没这么神秘, 渲染函数即是render，要渲染一个组建的内容时，渲染器会调用这个render拿到虚拟DOM，就可以把组件的内容渲染出来了。</p>
<h3 id="初识渲染器"><a href="#初识渲染器" class="headerlink" title="初识渲染器"></a>初识渲染器</h3><p>渲染器即是把<code>虚拟DOM</code>变成<code>真实DOM</code>并渲染到浏览器里的函数，先写一段虚拟DOM对象:</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    tag<span class="token operator">:</span> <span class="token string">'h1'</span><span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        onClick<span class="token operator">:</span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token string">'click me'</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>实现一个最简易的渲染器:</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">renderer</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> root</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> vnode<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
                key<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                vode<span class="token punctuation">.</span>props<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> vnode<span class="token punctuation">.</span>children <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> text <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>children<span class="token punctuation">)</span>
        el<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        vnode<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=></span> <span class="token function">renderer</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> el<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    root<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>这里的renderer函数接收两个参数:</p>
<ul>
<li>vnode: 虚拟DOM对象</li>
<li>container: 一个真实的DOM元素，作为挂载容器，渲染器会把渲染出的真实DOM挂载在该容器下。</li>
</ul>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">renderer</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">)</span></code></pre>

<p>这时浏览器就能运行这段代码了，渲染出’click me’文本，点击文本会弹出一个alert。</p>
<blockquote>
<p>这些只是在创建节点阶段的，渲染器的精髓都在更新节点的阶段。在之后的渲染器Diff部分会详细看。</p>
</blockquote>
<h3 id="组件的本质"><a href="#组件的本质" class="headerlink" title="组件的本质"></a>组件的本质</h3><p>虚拟DOM就是用来描述真实DOM的JS对象，那么Vue中的组件又是什么呢？</p>
<blockquote>
<p>其实虚拟DOM还能够描述组件，组件实际就是一组DOM元素的封装。</p>
</blockquote>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">MyComponent</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        tag<span class="token operator">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span>
        props<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token function-variable function">onClick</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        children<span class="token operator">:</span> <span class="token string">'click me'</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>可以看到，组件的返回值也是虚拟DOM，搞清楚组件的本质就可以用虚拟DOM描述组件了, 我们可以用虚拟DOM中的tag属性存储组件函数:</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    tag<span class="token operator">:</span> MyComponent
<span class="token punctuation">&#125;</span></code></pre>

<p>就像<code>tag: &#39;div&#39;</code>用来描述<code>&lt;div&gt;</code>标签一样，<code>tag: Component</code>用来描述组件，渲染器需要一个支持组件的能力，所以要将前面写过的renderer做个修改。</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">renderer</span> <span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> vnode<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">// 渲染原生标签元素</span>
        <span class="token function">mountElement</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> vnode<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">// 渲染组件</span>
        <span class="token function">mountComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">function</span> <span class="token function">mountElement</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> vnode<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
                key<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                vnode<span class="token punctuation">.</span>props<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> vnode<span class="token punctuation">.</span>children <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> text <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>children<span class="token punctuation">)</span>
        el<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        vnode<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=></span> <span class="token function">renderer</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> el<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">function</span> <span class="token function">mountComponent</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 直接调用组件函数，返回虚拟DOM</span>
    <span class="token keyword">const</span> subtree <span class="token operator">=</span> vnode<span class="token punctuation">.</span><span class="token function">tag</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 递归调用renderer渲染subtree</span>
    <span class="token function">renderer</span><span class="token punctuation">(</span>subtree<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>除了函数式组件，我们也能使用一个对象来代表组件，该对象有个render函数，其返回值代表组件要渲染的内容: </p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> MyComponent <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
            tag<span class="token operator">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span>
            props<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                <span class="token function-variable function">onClick</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            children<span class="token operator">:</span> <span class="token string">'click me'</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>针对这种情况也需要修改渲染器的判断条件: </p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// renderer</span>
<span class="token keyword">function</span> <span class="token function">renderer</span> <span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> vnode<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">mountElement</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> vnode<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">mountComponent</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// mountComponent</span>
<span class="token keyword">function</span> <span class="token function">mountComponent</span> <span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> subtree <span class="token operator">=</span> vnode<span class="token punctuation">.</span>tag<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">renderer</span><span class="token punctuation">(</span>subtree<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span></code></pre>

<blockquote>
<p>Vue中的有状态组件就是用对象结构来表达的，无状态组件则是用函数来表达的。</p>
</blockquote>
<blockquote>
<p>(*Vue 2.*中的functional组件在Vue 3.*中已经无需再做标记，因为在 Vue 3.* 中，所有的函数式组件都是用普通函数创建的，性能几乎无差异)</p>
</blockquote>
<h3 id="模版工作原理"><a href="#模版工作原理" class="headerlink" title="模版工作原理"></a>模版工作原理</h3><p>不论我们使用虚拟DOM(渲染函数)或是template模版写单文件组件，都是属于声明式的描述UI，Vue中模版是如何变为虚拟DOM的，有关这部分会在后续的编译器详解，这里只要了解大致步骤。</p>
<pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>handler<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>click me<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre>
<p>与直接手写:</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> onClick<span class="token operator">:</span> handler <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'click me'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>其实是一样的，只是后者少了html编译模版的过程，对于一个组件来说，它要渲染的内容最终都是通过渲染函数<code>render</code>来描述的。</p>
<p>完整示例：</p>
<pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>handler<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>click me<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>
    data<span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token comment">/* ... */</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    method<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token comment">/* ... */</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre>

<p>会被编译成:</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>
    data<span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token comment">/* ... */</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    method<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token comment">/* ... */</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> onClick<span class="token operator">:</span> handler <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'click me'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>其结果就是一个JS对象，里面含有一个render函数，就如我们上文所说的组件的本质一样，再编译成虚拟DOM交由渲染器渲染。</p>
<h3 id="Vue-js-是各个模块组成的有机整体"><a href="#Vue-js-是各个模块组成的有机整体" class="headerlink" title="Vue.js 是各个模块组成的有机整体"></a>Vue.js 是各个模块组成的有机整体</h3><p>组件的实现依赖于<code>渲染器</code>，模版的编译依赖于<code>编译器</code>，且编译后生成的代码是根据渲染器和虚拟DOM的设计决定的，因此Vue.js各个模块之间是互相关联、互相制约的，共同构成一个有机整体。</p>
<p>假设有个模版:</p>
<pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>foo<span class="token punctuation">"</span></span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cls<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre>

<p>根据上文介绍，我们知道编译器会把这段代码编译成渲染函数:</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> id<span class="token operator">:</span> <span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token keyword">class</span><span class="token operator">:</span> cls <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>经过工具函数<code>h</code>之后:</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        tag<span class="token operator">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span>
        props<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            id<span class="token operator">:</span> <span class="token string">'foo'</span><span class="token punctuation">,</span>
            <span class="token keyword">class</span><span class="token operator">:</span> cls
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>可以发现这段代码中<code>cls</code>是变量，它可能会发生变化，那么编译器是怎么一眼就知道哪些是静态属性，哪些是动态的呢？</p>
<p>实际上在编译的时候，编译器就会分析动态内容，并在交付给渲染器之前就标注出来，所以在生成虚拟DOM的时候，就会附带上这些信息:</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        tag<span class="token operator">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span>
        props<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            id<span class="token operator">:</span> <span class="token string">'foo'</span><span class="token punctuation">,</span>
            <span class="token keyword">class</span><span class="token operator">:</span> cls
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        patchFlags<span class="token operator">:</span> <span class="token number">1</span> <span class="token comment">// 假设数字 1 代表class属性是动态的</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>这样的配合下，渲染器就知道了什么地方需要当作动态处理，而不需要大费周章去寻找变更点，而之所以编译器会提前做好准备也是因为渲染器和虚拟DOM的设计决定的。</p>
</div><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">我很可爱，请给我钱.</div><div id="qr" style="display:none;"><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://shanghai-1309153523.cos.ap-shanghai.myqcloud.com/blogImage/alipay.jpg"><img loading="lazy" src="https://shanghai-1309153523.cos.ap-shanghai.myqcloud.com/blogImage/alipay.jpg" alt="支付宝" title="支付宝"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://shanghai-1309153523.cos.ap-shanghai.myqcloud.com/blogImage/wechatpay-qrcode.jpg"><img loading="lazy" src="https://shanghai-1309153523.cos.ap-shanghai.myqcloud.com/blogImage/wechatpay-qrcode.jpg" alt="微信支付" title="微信支付"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>卡西猫倒</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://meglody.github.io/read/%E8%AF%BB%E3%80%8AVue-js%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E3%80%8B-%20%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1%E6%A6%82%E8%A7%88/" title="读《Vue.js设计与实现》- 框架设计概览">https://meglody.github.io/read/%E8%AF%BB%E3%80%8AVue-js%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E3%80%8B-%20%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1%E6%A6%82%E8%A7%88/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> 许可协议。</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/read/%E8%AF%BB%E3%80%8AVue-js%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E3%80%8B-%20%E5%93%8D%E5%BA%94%E7%B3%BB%E7%BB%9F/" rel="prev" title="读《Vue.js设计与实现》- 响应系统"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">读《Vue.js设计与实现》- 响应系统</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/diary/Javascript%E5%87%BD%E6%95%B0%E4%BD%9C%E7%94%A8%E5%9F%9F%E4%B8%8E%E9%97%AD%E5%8C%85/" rel="next" title="Javascript函数作用域与闭包"><span class="post-nav-text">Javascript函数作用域与闭包</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>如果您有任何关于博客内容的相关讨论，欢迎前往 <a href="https://github.com/Meglody/Meglody.github.io/discussions" target="_blank">GitHub Discussions</a> 与我交流。</span><br></div><div id="waline"></div><script>Yun.utils.getScript("https://cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js", () => {
  const walineConfig = {"enable":true,"serverURL":"https://gh-comments-5z0r2ute3-meglody.vercel.app/","comment":true,"visitor":true,"emoji":["https://cdn.jsdelivr.net/gh/walinejs/emojis@latest/bilibili/","https://cdn.jsdelivr.net/gh/walinejs/emojis@latest/weibo/","https://cdn.jsdelivr.net/gh/walinejs/emojis@latest/qq/"],"locale":{"placeholder":"填写邮箱，可以收到回复通知哦～"},"requiredMeta":["nick"],"el":"#waline","lang":"zh-CN"}
  walineConfig.path = "/read/%E8%AF%BB%E3%80%8AVue-js%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E3%80%8B-%20%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1%E6%A6%82%E8%A7%88/"
  walineConfig.dark = 'html[data-user-color-scheme="dark"]'
  new Waline(walineConfig)
}, window.Waline);</script></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2023 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> 卡西猫倒</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v5.4.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.7.0</span></div></footer><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#6200ee" stroke-width="2" stroke-linecap="round"></circle></svg></a><script>const date = new Date();
const today = (date.getMonth() + 1) + "-" + date.getDate()
const mourn_days = ["5-12","12-13"]
if (mourn_days.includes(today)) {
  document.documentElement.style.filter = "grayscale(1)";
}</script></div></body></html>